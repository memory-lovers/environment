---
- hosts: 192.168.0.201
  user: vagrant
  sudo: yes
  tasks:
##
    - name: apt-get install ruby1.9.3  mysql-server mysql-server libmysqld-dev python-mysqldb
      apt: pkg={{ item }}
      with_items:
        - ruby1.9.3
        - mysql-server
        - libmysqld-dev
        - python-mysqldb

##
    - name: gem install bundler
      gem: name=bundler state=latest user_install=False
    - name: gem install json -v 1.8.1
      gem: name=json version=1.8.1 state=present user_install=False
    - name: gem install mysql2 -v 0.3.16
      gem: name=mysql2 version=0.3.16 state=present user_install=False

##
    - name: wget redmine-2.5.1
      get_url: url="http://www.redmine.org/releases/redmine-2.5.1.tar.gz" dest="/var/tmp/redmine-2.5.1.tar.gz"
    - name: tar zxvf redmine-2.5.1
      command: tar zxvf redmine-2.5.1.tar.gz chdir=/var/tmp creates=/opt/redmine-2.5.1
    - name: mv redmine-2.5.1
      command: mv redmine-2.5.1 /opt chdir=/var/tmp creates=/opt/redmine-2.5.1
    - name: ln -s redmine-2.5.1
      command: ln -s /opt/redmine-2.5.1 /opt/redmine creates=/opt/redmine
##
    - name: setup db for redmine
      mysql_db: name=redmine state=present encoding=utf8 login_user=root login_host=localhost login_password=useruser
#TODO add mysql user - redmine
#TODO use template for setup database.yml
    - name: setup database.yml
      shell: cp config/database.yml.example config/database.yml chdir=/opt/redmine creates=/opt/redmine/config/database.yml

##
    - name: redmine install
      shell: bundle install --without development test postgresql sqlite rmagick chdir=/opt/redmine removes=/opt/redmine
    - name: rake generate_secret_token
      shell: rake generate_secret_token chdir=/opt/redmine
    - name: RAILS_ENV=production rake db:migrate
      shell: "bundle exec rake db:migrate RAILS_ENV=production chdir=/opt/redmine"

##
    - name: mkdir tmp public/plugin_assets
      shell: mkdir tmp public/plugin_assets chdir=/opt/redmine
      ignore_errors: True
    - name: chown -R www-data:www-data files log tmp public/plugin_assets
      shell: chown -R www-data:www-data files log tmp public/plugin_assets chdir=/opt/redmine
      ignore_errors: True
    - name: chmod -R 755 files log tmp public/plugin_assets
      shell: chmod -R 755 files log tmp public/plugin_assets chdir=/opt/redmine
      ignore_errors: True

##
    - name: apt-get install -y apache2 libapache2-mod-passenger libapache2-mod-svn
      apt: pkg={{ item }}
      with_items:
        - apache2
        - libapache2-mod-passenger
        - libapache2-mod-svn

    - name: ln -s /opt/redmine/public/ /var/www/redmine
      command: ln -s /opt/redmine/public/ /var/www/redmine creates=/var/www/redmine

##
#TODO use templete for setup site-available
#TODO use templete for setup svn-config
